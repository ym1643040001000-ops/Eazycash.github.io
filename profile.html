import { db } from './firebase.js';
import { ref, onValue, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

export function loadProfile(user){
  document.getElementById('userEmail').textContent = user.email || 'مستخدم';
  document.getElementById('userId').textContent    = `ID: ${user.uid.slice(0,8)}…`;
  const link = `${location.origin}/join?ref=${user.uid}`;
  document.getElementById('refLink').textContent = link;

  onValue(ref(db, `users/${user.uid}/balance`),(s)=>{
    const v = s.exists()? s.val():0;
    document.getElementById('userBalance').textContent = `${Number(v).toLocaleString('ar-EG')} EGP`;
  });

  const tbody = document.querySelector('#txTable tbody');
  onValue(ref(db, `transactions/${user.uid}`),(s)=>{
    tbody.innerHTML='';
    if(!s.exists()) return;
    const rows = Object.values(s.val()).sort((a,b)=>b.ts-a.ts).slice(0,30);
    rows.forEach(t=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.type==='DEPOSIT'?'إيداع':'سحب'}</td><td>${Number(t.amount).toLocaleString('ar-EG')}</td><td>${new Date(t.ts).toLocaleString('ar-EG')}</td><td>${t.status}</td>`;
      tbody.appendChild(tr);
    });
  });
}
